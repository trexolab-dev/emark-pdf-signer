#!/bin/bash
# ============================================================================
# eMark PDF Signer - Launcher Script for Linux (x86/i386)
# TrexoLab - https://trexolab.com
# ============================================================================
#
# This script launches eMark PDF Signer with the bundled JRE 8 x86 (32-bit).
# Supports opening PDF files via command line or file association.
#
# MEMORY PROFILES:
#   normal  (default): -Xmx2g
#   large:             -Xmx4g
#   xlarge:            -Xmx8g
#
# Usage:
#   emark                        # Normal profile
#   emark large                  # Large profile
#   emark xlarge                 # Extra Large profile
#   emark /path/to/file.pdf     # Open PDF (normal profile)
#   emark large /path/to/file.pdf  # Open PDF (large profile)
# ============================================================================

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Bundled JRE location (x86 version)
JAVA_EXE="$SCRIPT_DIR/jre8-x86/bin/java"

# JAR file location
JAR_FILE="$SCRIPT_DIR/eMark-PDF-Signer.jar"

# Validate bundled Java runtime exists
if [ ! -x "$JAVA_EXE" ]; then
    if command -v zenity &> /dev/null; then
        zenity --error --title="eMark PDF Signer" --text="Java Runtime Not Found\n\nThe bundled Java 8 x86 (32-bit) runtime was not found.\n\nPlease reinstall eMark PDF Signer."
    elif command -v kdialog &> /dev/null; then
        kdialog --error "Java Runtime Not Found\n\nThe bundled Java 8 x86 (32-bit) runtime was not found.\n\nPlease reinstall eMark PDF Signer."
    else
        echo "ERROR: Java Runtime Not Found"
        echo "The bundled Java 8 x86 (32-bit) runtime was not found at: $JAVA_EXE"
        echo "Please reinstall eMark PDF Signer."
    fi
    exit 1
fi

# Validate JAR file exists
if [ ! -f "$JAR_FILE" ]; then
    if command -v zenity &> /dev/null; then
        zenity --error --title="eMark PDF Signer" --text="Application Not Found\n\nThe application JAR file was not found.\n\nPlease reinstall eMark PDF Signer."
    elif command -v kdialog &> /dev/null; then
        kdialog --error "Application Not Found\n\nThe application JAR file was not found.\n\nPlease reinstall eMark PDF Signer."
    else
        echo "ERROR: Application Not Found"
        echo "The application JAR file was not found at: $JAR_FILE"
        echo "Please reinstall eMark PDF Signer."
    fi
    exit 1
fi

# Parse arguments - detect profile and/or PDF file path
PROFILE="normal"
PDF_FILE=""

# Check first argument
ARG1="${1:-}"
ARG2="${2:-}"

if [ -n "$ARG1" ]; then
    # Convert to lowercase for comparison
    ARG1_LOWER=$(echo "$ARG1" | tr '[:upper:]' '[:lower:]')

    case "$ARG1_LOWER" in
        normal)
            PROFILE="normal"
            PDF_FILE="$ARG2"
            ;;
        large)
            PROFILE="large"
            PDF_FILE="$ARG2"
            ;;
        xlarge)
            PROFILE="xlarge"
            PDF_FILE="$ARG2"
            ;;
        *)
            # Not a profile, assume it's a file path
            PDF_FILE="$ARG1"
            ;;
    esac
fi

# Set Java options based on profile
case "$PROFILE" in
    normal)
        JAVA_OPTS="-Xms512m -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
        ;;
    large)
        JAVA_OPTS="-Xms512m -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
        ;;
    xlarge)
        JAVA_OPTS="-Xms1g -Xmx8g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
        ;;
esac

# Launch the application
if [ -n "$PDF_FILE" ]; then
    exec "$JAVA_EXE" $JAVA_OPTS -jar "$JAR_FILE" "$PDF_FILE"
else
    exec "$JAVA_EXE" $JAVA_OPTS -jar "$JAR_FILE"
fi
